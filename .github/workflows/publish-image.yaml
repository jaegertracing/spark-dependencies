name: "Publish Container Image"

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish in addition to `latest`"
        required: true
        type: string
  pull_request:

jobs:
  publish:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - variant: cassandra
            es_version: "8.13.4"
            description: "Cassandra storage (compatible with ES 7.17+/8.x)"
          - variant: elasticsearch7
            es_version: "7.17.29"
            description: "Elasticsearch 7.12-7.16"
          - variant: elasticsearch8
            es_version: "8.13.4"
            description: "Elasticsearch 7.17+ and 8.x"
          - variant: elasticsearch9
            es_version: "9.1.3"
            description: "Elasticsearch 9.x"

    steps:
      - uses: actions/checkout@v4.2.2

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3.10.0
        with:
          install: true
          platforms: |
            linux/amd64
            linux/arm64

      - name: Compute Tags
        id: compute-tags
        run: |
          prefix="ghcr.io/jaegertracing/spark-dependencies/spark-dependencies"
          variant="${{ matrix.variant }}"
          
          # For main releases, use variant suffix
          if [[ "${{ github.event_name }}" == "release" ]] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            release=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')
            tags="$prefix:$release-$variant"
            
            # elasticsearch9 gets the 'latest' tag
            if [[ "$variant" == "elasticsearch9" ]]; then
              tags="$tags,$prefix:latest"
            fi
          elif [[ -n "${{ inputs.tag }}" ]]; then
            tags="$prefix:${{ inputs.tag }}-$variant"
          else
            # For PR builds, use variant only
            tags="$prefix:pr-$variant"
          fi

          echo "Computed tags for publication ($variant): $tags"
          echo "tags=$tags" >> $GITHUB_OUTPUT

      - name: Login to GitHub Package Registry
        uses: docker/login-action@v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6.15.0
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }} # allows dry-run validation on PR
          tags: ${{ steps.compute-tags.outputs.tags }}
          platforms: |
            linux/amd64
            linux/arm64
          build-args: |
            ELASTICSEARCH_SPARK_VERSION=${{ matrix.es_version }}
            VARIANT=${{ matrix.variant }}
