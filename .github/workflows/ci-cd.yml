#
# Copyright (c) The Jaeger Authors
# SPDX-License-Identifier: Apache-2.0
#

name: "CI/CD Pipeline"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish in addition to `latest`"
        required: true
        type: string

jobs:
  build-jars:
    name: Build JAR - ${{ matrix.variant }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: cassandra
          - variant: elasticsearch7
            es_version: "7.17.29"
          - variant: elasticsearch8
            es_version: "8.13.4"
          - variant: elasticsearch9
            es_version: "9.1.3"
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Build JAR for Cassandra
        if: matrix.variant == 'cassandra'
        run: |
          ./mvnw clean package --batch-mode -Dlicense.skip=true -DskipTests \
            -pl jaeger-spark-dependencies-cassandra -am

      - name: Build JAR for Elasticsearch
        if: matrix.variant != 'cassandra'
        run: |
          ./mvnw clean package --batch-mode -Dlicense.skip=true -DskipTests \
            -Dversion.elasticsearch.spark=${{ matrix.es_version }} \
            -pl jaeger-spark-dependencies-elasticsearch -am

      - name: Prepare artifact for Cassandra
        if: matrix.variant == 'cassandra'
        run: |
          mkdir -p artifact-target
          cp jaeger-spark-dependencies-cassandra/target/jaeger-spark-dependencies-cassandra-0.0.1-SNAPSHOT.jar \
            artifact-target/

      - name: Prepare artifact for Elasticsearch
        if: matrix.variant != 'cassandra'
        run: |
          mkdir -p artifact-target
          cp jaeger-spark-dependencies-elasticsearch/target/jaeger-spark-dependencies-elasticsearch-0.0.1-SNAPSHOT.jar \
            artifact-target/

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.variant }}
          path: artifact-target/*.jar
          retention-days: 1

  e2e-tests:
    name: E2E Tests - ${{ matrix.variant }}
    runs-on: ubuntu-24.04
    needs: build-jars
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: cassandra
            job_tag: test-cassandra
            project: jaeger-spark-dependencies-cassandra
          - variant: elasticsearch7
            es_version: "7.17.29"
            job_tag: test-es7
            project: jaeger-spark-dependencies-elasticsearch
            es_test_ver: "7.3.0"
          - variant: elasticsearch8
            es_version: "8.13.4"
            job_tag: test-es8
            project: jaeger-spark-dependencies-elasticsearch
            es_test_ver: "8.3.1"
          - variant: elasticsearch9
            es_version: "9.1.3"
            job_tag: test-es9
            project: jaeger-spark-dependencies-elasticsearch
            es_test_ver: "9.1.3"
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-${{ matrix.variant }}
          path: target/

      - name: Build local Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          load: true
          push: false
          tags: ghcr.io/jaegertracing/spark-dependencies/spark-dependencies:${{ matrix.job_tag }}
          build-args: |
            VARIANT=${{ matrix.variant }}

      - name: Run integration tests
        env:
          SPARK_DEPENDENCIES_JOB_TAG: ${{ matrix.job_tag }}
          ELASTICSEARCH_VERSION: ${{ matrix.es_test_ver }}
          MAVEN_ES_PROP: ${{ matrix.es_version != '' && format('-Dversion.elasticsearch.spark={0}', matrix.es_version) || '' }}
        run: |
          ./mvnw --batch-mode test -am \
            -pl ${{ matrix.project }} \
            $MAVEN_ES_PROP

  publish:
    name: Publish - ${{ matrix.variant }}
    runs-on: ubuntu-24.04
    needs: e2e-tests
    if: github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: cassandra
            description: "Cassandra storage"
          - variant: elasticsearch7
            es_version: "7.17.29"
            description: "Elasticsearch 7.12-7.16"
          - variant: elasticsearch8
            es_version: "8.13.4"
            description: "Elasticsearch 7.17+ and 8.x"
          - variant: elasticsearch9
            es_version: "9.1.3"
            description: "Elasticsearch 9.x"
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-${{ matrix.variant }}
          path: target/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@f9f531f0b89f3b84ca20b6bf63b3e3f4e57e6b35 # v3.3.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          install: true
          platforms: |
            linux/amd64
            linux/arm64

      - name: Compute Tags
        id: compute-tags
        run: |
          prefix="ghcr.io/jaegertracing/spark-dependencies/spark-dependencies"
          variant="${{ matrix.variant }}"
          
          # For main releases, use variant suffix
          if [[ "${{ github.event_name }}" == "release" ]] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            release=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')
            tags="$prefix:$release-$variant"
            
            # elasticsearch9 gets the 'latest' tag as it supports the newest ES version
            if [[ "$variant" == "elasticsearch9" ]]; then
              tags="$tags,$prefix:latest"
            fi
          elif [[ -n "${{ inputs.tag }}" ]]; then
            tags="$prefix:${{ inputs.tag }}-$variant"
          else
            # For main branch builds, use main-variant
            tags="$prefix:main-$variant"
          fi

          echo "Computed tags for publication ($variant): $tags"
          echo "tags=$tags" >> $GITHUB_OUTPUT

      - name: Login to GitHub Package Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch images
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          push: true
          tags: ${{ steps.compute-tags.outputs.tags }}
          platforms: |
            linux/amd64
            linux/arm64
          build-args: |
            VARIANT=${{ matrix.variant }}
