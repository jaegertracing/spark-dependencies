name: "Continuous Integration"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  latest-jaeger:
    name: Latest Jaeger and Cassandra 4.x
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: temurin
          java-version: '11'
      - name: Build docker image to be used in tests
        uses: docker/build-push-action@v2.7.0
        with:
          context: .
          push: false
          load: true
          tags: ghcr.io/jaegertracing/spark-dependencies/spark-dependencies:test-cassandra
          build-args: |
            VARIANT=cassandra
      - name: test
        run: SPARK_DEPENDENCIES_JOB_TAG=test-cassandra ./mvnw --batch-mode clean test -am -pl jaeger-spark-dependencies-cassandra

  latest-jaeger-es7:
    name: Latest Jaeger and ES7
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: temurin
          java-version: '11'
      - name: Build docker image to be used in tests
        uses: docker/build-push-action@v2.7.0
        with:
          context: .
          push: false
          load: true
          tags: ghcr.io/jaegertracing/spark-dependencies/spark-dependencies:test-es7
          build-args: |
            VARIANT=elasticsearch7
            ELASTICSEARCH_SPARK_VERSION=7.17.10
      - name: test
        run: |
          SPARK_DEPENDENCIES_JOB_TAG=test-es7 \
          ELASTICSEARCH_VERSION=7.3.0 \
          ./mvnw --batch-mode clean test -am \
            -pl jaeger-spark-dependencies-elasticsearch \
            -Dversion.elasticsearch.spark=7.17.10

  latest-jaeger-es8:
    name: Latest Jaeger and ES8
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: temurin
          java-version: '11'
      - name: Build docker image to be used in tests
        uses: docker/build-push-action@v2.7.0
        with:
          context: .
          push: false
          load: true
          tags: ghcr.io/jaegertracing/spark-dependencies/spark-dependencies:test-es8
          build-args: |
            VARIANT=elasticsearch8
            ELASTICSEARCH_SPARK_VERSION=8.13.4
      - name: test
        run: |
          SPARK_DEPENDENCIES_JOB_TAG=test-es8 \
          ELASTICSEARCH_VERSION=8.3.1 \
          ./mvnw --batch-mode clean test -am \
            -pl jaeger-spark-dependencies-elasticsearch \
            -Dversion.elasticsearch.spark=8.13.4

  latest-jaeger-es9:
    name: Latest Jaeger and ES9
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: temurin
          java-version: '11'
      - name: Build docker image to be used in tests
        uses: docker/build-push-action@v2.7.0
        with:
          context: .
          push: false
          load: true
          tags: ghcr.io/jaegertracing/spark-dependencies/spark-dependencies:test-es9
          # Build mega-jar (VARIANT=unified) with both Cassandra and Elasticsearch support.
          # While ES9 doesn't require the mega-jar, we build it here to ensure it's tested at least once in CI
          build-args: |
            VARIANT=unified
            ELASTICSEARCH_SPARK_VERSION=9.1.3
      - name: test
        run: |
          SPARK_DEPENDENCIES_JOB_TAG=test-es9 \
          ELASTICSEARCH_VERSION=9.1.3 \
          ./mvnw --batch-mode clean test -am \
            -pl jaeger-spark-dependencies-elasticsearch \
            -Dversion.elasticsearch.spark=9.1.3
